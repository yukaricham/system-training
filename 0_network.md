# この章で学べること
- どのようにしてネットワークが接続しているのかがわかる
- 名前解決の仕組みがわかる
- ブラウザが何をやっているのかがわかる

# ネットワーク
何らかのURLへアクセスする場合、ブラウザ上からはURLを入力しているだけに見えますが実際の動きは違います。

http://nanapi.jp

ブラウザ経由でWebサイトへアクセスする場合、ネットワークを経由して接続するような仕組みになっていますが、ネットワークというものは直接ドメインに対してアクセスすることができません。

通信は基本的にIPアドレスをもっている同士で通信が行われています。それでは実際にどのようにして通信をおこなっているのか確認してみましょう。

# IPアドレスを調べる
Windowsはコマンドプロンプト、Macはターミナルを起動してください。どちらも標準でインストールされています。

Windows

```
ipconfig
```

Mac

```
ifconfig
```

# IPアドレスとはなにか
さて、IPアドレスが表示されました。これは、nanapi社内においてユニークなものです。ネットワーク上における住所のようなもので、決して重複してはいけません。仮に重複した場合は、ネットワークの疎通がおかしくなります。

このIPアドレスは固定することもできますが、nanapi社内においてPCを使用する場合はすべて自動的に付与されるような仕組みになっています。

それでは、ネットワークが疎通しているかの確認を行ってみましょう。Windows/Macともに以下のコマンドを実行してください。

```
ping 10.0.3.1
```

いろいろかえってくれば成功です。これはnanapi社内のネットワーク上に、10.0.3.1というマシンが存在するという意味です。それではあえて存在しないマシンも実行してみましょう。

```
ping 10.1.1.1
```
エラーが返って来ていると思います。このようにして、エンジニアはサーバがネットワーク上に存在しているかどうかをチェックしています。

# TCP/IP
さて、IPアドレスの規則に気づいてきたかと思いますが、ネットワークにおける住所にあたるIPアドレスは以下のようにして表記します。

xxx.xxx.xxx.xxx

0 - 255の数値を.区切りで4つ並べたものがIPアドレスです。本来は2進数で表現されているものではありますが、わかりやすいようにこのように表記されるようになっています。そのため、世の中に存在することができるIPアドレスの数は有限です。これがここ数年間言われ続けている、IPアドレス枯渇問題という問題です。

# イントラネット内での通信
世の中にあるすべてのマシンがインターネット上で通信するためのIPアドレスを持ってしまうと大変です。そのため、ネットワークを構成するために家庭内や社内のみで通信を行うことができるローカルIPアドレスというものをふることができます。

先ほど表示されたIPアドレスは、10.xx.xx.xxでした。これは、ローカルネットワーク用に付与されているIPアドレスで、直接インターネットに接続することはできません。例えば、以下のIPアドレスなどはすべてローカルネットワーク用のIPアドレスとして定義されています。社内ではユニークである必要がありますが、全く別のネットワークになる場合（他社など）は、ここが重複していても全く問題ありません。

- 10.xx.xx.xx
- 172.xx.xx.xx
- 192.xx.xx.xx

また、上記以外にも特殊な用途で割り当てられているIPアドレスはいくつかありますが、これは通信を行う上での決まりとなっています。

# インターネットにおける通信
しかし、インターネットと接続するためには、ローカルネットワークだけでは通信できません。いま保持しているローカルIPアドレスをグローバルIPアドレスに変換して外部にあるネットワークと通信をする必要があります。この役割をになっているのが「ルーター」と呼ばれるものです。

このルーターという機器によって、1本のインターネット回線であっても同時に複数人がインターネットに接続することができます。図で言うと以下のようになります。

# DNSの仕組み
通信をする上でIPアドレスが必要という話をしましたが、これでもまだ人間にとっては扱いづらいです。打ち間違いがおきるし、なによりも覚えづらい。

そのために、ドメインとIPアドレスをひもづける仕組みがあります。この仕組みのことをDNSと呼びます。 **Domain Name System** の略称です。そのため、実際の通信を行う際はドメインからIPアドレスに変換をしてから行っています。これを **名前解決** と呼びます。

それでは、ドメインがどんなIPアドレスを保持しているのか見てみましょう。以下のコマンドでドメインに対応するIPアドレスを見ることができます。

```
nslookup nanapi.jp
```

これで何らかのIPアドレスが返って来ましたね。このIPアドレスでもアクセスすることができます。ブラウザから直接アクセスしてみましょう。アクセスすることができましたね。どんなドメインでもこのように対応するIPアドレスを調べることができます。

# コラム：DNSはどのようにして名前解決をしているか
DNSサーバは世界に無数にありますが、最上位にあるDNSサーバは世界に13台しかありません。このDNSサーバで **TLD(Top Level Domain)**を管理しています。TLDとは、.comや.jpといったドメインの一番うしろに付いているものです。

ドメインにおける名前解決は以下のようにして実施されます。例えば、以下のドメインを例にとって見て行きましょう。

```
nanapi.jp
```

- ルートサーバに問い合わせて、.jpドメインを管理しているDNSサーバを取得
- .jpを管理しているサーバに問い合わせて、nanapi.jpを管理しているDNSサーバを取得
- nanapi.jpを管理しているサーバに問い合わせて、nanapi.jpのIPアドレスを取得

このようにして、最上位にあるDNSサーバを中心に数多くのDNSサーバが拠点ごとに点在しています。また、そのDNSサーバもそれぞれDNSの名前解決の情報をキャッシュすることになります。そのため、DNSの設定変更はすぐに反映されることがなく、DNSのキャッシュ情報がきえて新しい情報に書き換わるまで待つ必要があります。

余談ですが、nanapi社内にも社内からのみアクセスできるDNSサーバがあります。fs01.localやprinter01.localという名前でファイルサーバやプリンタサーバに接続することができるのはDNSサーバがあるためです。

# プロトコル
IPアドレスによって、通信することができるようになりました。しかし、IPアドレスがわかっているだけでは情報をやりとりする上では不十分です。

ネットワーク上には様々な情報がやりとりされています。httpから始まるWebを閲覧するための情報もそうですが、それだけではありません。誰もが好き勝手な形式で情報の形式を定義されたら困ります。そのために、通信を行う上でのある程度のルールを定義するための仕組みがあります。

これを**Protocol(プロトコル)**と呼びます。プロトコルには以下のようなものがあります。あくまで一例ですが、以下にあげるものは聞いたことがあるものもあるでしょう。

- HTTP
- HTTPS
- FTP
- DNS
- POP
- IMAP

これはあくまで一例のため、他にもたくさんのプロトコルがあります。この決まりがあるため、IEやGoogle Chromeなどブラウザが変わってもWebを閲覧することができます。

そしてプロトコルが策定されると、RFCというドキュメントになります。この中で様々なHTTPにおける仕様が決まっています。以下はHTTPのRFCです。**Hyper Transwer Text Protocol**の略です。

http://www.ietf.org/rfc/rfc2616.txt

# HTTPというプロトコル
さて、もっとも目にすることの多い**HTTP**について少し触れます。HTTPは見慣れているでしょう。以下のようにURLと呼ばれるものですね。

http://nanapi.jp

一般的には、httpごと含めてURLと呼ばれますがこのhttpの部分はhttpというプロトコルで通信するよという意味です。そのため、httpsプロトコルで通信を行う場合は以下の様なURLになります。

https://nanapi.jp

httpsというのはhttpの通信部分を暗号化しセキュアにしたプロトコルです。これによりネットワーク上を行き交うデータの盗聴をほぼ確実に防ぐことができます。このようにして通信を行うことができます。

# ブラウザがやっていること
さてここまでの知識を踏まえた上でブラウザが行っている作業を説明します。簡単に説明すると、WebブラウザでWebサイトをみるまでの仕組みは以下の様な手順になっています。

1. 入力されたURLを名前解決する
2. そのIPアドレスを持っているサーバに対して、HTTP Requestを送信する
3. 対象のサーバから、HTTP Responseが返ってくる
4. ブラウザは帰ってきたHTTP Responseに入っているHTMLを解釈し、見やすいように組み立てる
5. HTMLを解釈した上で、別途必要な作業を実行する
	- 画像を取得
	- CSSを取得
	- Javascriptを取得
	- Javascriptを実行

# 手動でHTTPリクエストを送ろう

さて、上記で説明しましたが2番にあったHTTP Requestの送信を手動でやってみましょう。

```
$ telnet wadap.jp 80
Trying 210.172.148.195...
Connected to wadap.jp.
Escape character is '^]'.
GET / HTTP/1.0

HTTP/1.1 200 OK
Date: Thu, 06 Feb 2014 07:28:48 GMT
Server: Apache
Last-Modified: Thu, 20 Dec 2012 02:24:40 GMT
ETag: "25100ccc-8-4d13f6edd8a00"
Accept-Ranges: bytes
Content-Length: 8
Connection: close
Content-Type: text/html

Hello !
```

http://blog.heiichi.com/?eid=805729
